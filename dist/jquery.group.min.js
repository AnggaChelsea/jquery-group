(function(){!function(a){var b,c,d,e,f,g,h,i,j,k;return j=function(a){return a-1+a%2},k=function(a){var b;return i.test(a)?(b=parseInt(a),isNaN(b)?null:b):null},c=function(b){return a(b.currentTarget)},b=function(a){return[a,c(a)]},g=function(a,b){return a.map(function(a){var c,d,e,f;return d=b.filter(function(a){return null!==a.a.score&&null!==a.b.score}).filter(function(b){return b.a.name===a||b.b.name===a}).map(function(b){return b.a.name===a?{ownScore:b.a.score,opponentScore:b.b.score}:{ownScore:b.b.score,opponentScore:b.a.score}}),f=d.filter(function(a){return a.ownScore>a.opponentScore}).size(),c=d.filter(function(a){return a.ownScore<a.opponentScore}).size(),e=d.filter(function(a){return a.ownScore===a.opponentScore}).size(),{name:a,wins:f,losses:c,ties:e,points:3*f+e}}).sortBy(function(a){return-a.points})},i=new RegExp(/^[0-9]+$/),f=0,d=function(){return++f},e=function(e,f,h,i){var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;return i&&e.addClass("read-write"),C=function(){var b,d,e;return b=Handlebars.compile('        <div class="standings">        <table>        <colgroup>        <col style="width: 60%">        <col span="4" style="width: 10%">        </colgroup>        <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th></tr>        {{#each this}}        <tr><td>{{name}}</td><td>{{wins}}</td><td>{{losses}}</td><td>{{ties}}</td><td>{{points}}</td></tr>        {{/each}}        </table>        </div>'),e=Handlebars.compile('        <div class="standings">        <table>        <colgroup>        <col style="width: 60%">        <col span="4" style="width: 10%">        </colgroup>        <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>Drop?</th></tr>        {{#each this}}        <tr><td><input class="name" type="text" data-prev="{{name}}" value="{{name}}" /></td><td>{{wins}}</td><td>{{losses}}</td><td>{{ties}}</td><td>{{points}}</td><td class="drop" data-name="{{name}}">Drop</td></tr>        {{/each}}        <tr><td><input class="add" type="text" value="{{name}}" /></td><td colspan="5"><input type="submit" value="Add" disabled="disabled" /></td></tr>        </table>        </div>'),d=Handlebars.compile('<div class="rounds"></div>'),{standings:function(d,f,g,h){var j,k,l,m;return h=h||_([]),i?(m=a(e(h.value())),j=m.find("input[type=submit]"),l=m.find("input").asEventStream("keyup").map(c).map(function(a){var b,c,d;return d=a.val(),b=a.attr("data-prev"),c=d.length>0&&(!h.pluck("name").contains(d)||b===d),{el:a,value:d,valid:c}}).toProperty(),l.onValue(function(a){return a.el.toggleClass("conflict",!a.valid),a.el.hasClass("add")?a.valid?j.removeAttr("disabled"):j.attr("disabled","disabled"):void 0}),k=l.map(function(a){return a.valid}).toProperty(),m.find("input.name").asEventStream("change").filter(k).map(".target").map(a).onValue(function(a){return f.push({from:a.attr("data-prev"),to:a.val()}),a.attr("data-prev",a.val())}),m.find("input.add").asEventStream("change").filter(k).map(".target").map(a).map(function(a){return a.val()}).onValue(function(a){return d.push(a)}),m.find("td.drop").asEventStream("click").map(".target").map(a).map(function(a){return a.attr("data-name")}).onValue(function(a){return g.push(a)}),m):a(b(h.value()))},rounds:a(d())}}(),o=function(){var d;return d=Handlebars.compile('        <div data-roundId="{{round}}" class="round" style="width: {{width}}%">        {{#if round}}          <header>Round {{round}}</header>        {{else}}          <header>Unassigned</header>        {{/if}}        </div>'),{create:function(f,g){return new function(){var h,j;j=a(d({round:g,width:100})),this.markup=j,i&&(h=0,j.asEventStream("dragover").doAction(".preventDefault").onValue(function(){}),j.asEventStream("dragenter").doAction(".preventDefault").map(c).onValue(function(a){0===h&&a.addClass("over"),h++}),j.asEventStream("dragleave").doAction(".preventDefault").map(c).onValue(function(a){h--,0===h&&a.removeClass("over")}),j.asEventStream("drop").doAction(".preventDefault").map(b).onValues(function(a,b){var c,d;h=0,c=a.originalEvent.dataTransfer.getData("Text"),d=e.find("[data-matchId='"+c+"']"),b.append(d),b.removeClass("over"),f.push({match:parseInt(c),round:parseInt(b.attr("data-roundId"))})}))}}}}(),n=function(){var d,f;return d=Handlebars.compile('        <div data-matchId="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <div class="home">{{a.score}}</div>        <div class="away">{{b.score}}</div>        <span class="away">{{b.name}}</span>        </div>'),f=Handlebars.compile('        <div data-matchId="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <input type="text" class="home" value="{{a.score}}" />        <input type="text" class="away" value="{{b.score}}" />        <span class="away">{{b.name}}</span>        </div>'),{create:function(g,h){return new function(){var j;return h=a.extend({},h),h.draggable=(null!=i).toString(),i?(j=a(f(h)),this.markup=j,j.find("input").asEventStream("keyup").map(c).onValue(function(a){return a.toggleClass("conflict",null===k(a.val()))}),j.find("input").asEventStream("change").onValue(function(){var a,b,c;return a=k(j.find("input.home").val()),b=k(j.find("input.away").val()),null!==a&&null!==b?(c={a:{name:h.a.name,score:a},b:{name:h.b.name,score:b}},g.push(c)):void 0}),j.asEventStream("dragstart").map(".originalEvent").map(b).onValues(function(a,b){return a.dataTransfer.setData("Text",h.id),b.css("opacity",.5),e.find(".round").addClass("droppable")}),j.asEventStream("dragend").map(".originalEvent").map(b).onValues(function(a,b){return b.css("opacity",1),e.find(".droppable").removeClass("droppable")}),void 0):(this.markup=a(d(h)),void 0)}}}}(),m=a('<div class="standings"></div>').appendTo(e),l=C.rounds.appendTo(e),q=new Bacon.Bus,w=new Bacon.Bus,y=new Bacon.Bus,A=new Bacon.Bus,r=new Bacon.Bus,x=new Bacon.Bus,p=q.toProperty({participants:_([]),matches:_([])}),s=p.sampledBy(w,function(a,b){var c,e;return a.participants.size()>0&&(c=a.participants.map(function(a){return{id:d(),a:{name:a,score:null},b:{name:b,score:null}}}),a.matches=a.matches.union(c.value())),a.participants.push(b),e=j(a.participants.size()),_(_.range(l.find(".round").length,e)).each(function(a){return l.append(o.create(r,a+1).markup)}),a}),u=p.sampledBy(x,function(a,b){var c,d,f;return a.matches.filter(function(a){return a.a.name===b||a.b.name===b}).map(function(a){return a.id}).forEach(function(a){return e.find("[data-matchId='"+a+"']").remove()}),f=j(a.participants.size()),a.participants=a.participants.filter(function(a){return a!==b}),d=j(a.participants.size()),a.matches=a.matches.filter(function(a){return a.a.name!==b&&a.b.name!==b}).map(function(a){return a.round>d&&(a.round=0),a}),c=e.find("[data-roundid='0']"),_(_.range(d+1,f+1)).each(function(a){var b,d;return d=l.find("[data-roundid='"+a+"']"),b=d.find(".match"),c.append(b),d.remove()}),a}),B=p.sampledBy(A,function(a,b){return a.matches=a.matches.map(function(a){return a.a.name===b.a.name&&a.b.name===b.b.name?(void 0!==b.round&&(a.round=b.round),a.a.score=b.a.score,a.b.score=b.b.score):a.a.name===b.b.name&&a.b.name===b.a.name&&(void 0!==b.round&&(a.round=b.round),a.a.score=b.b.score,a.b.score=b.a.score),a}),a}),v=p.sampledBy(y,function(a,b){return a.participants=a.participants.map(function(a){return a===b.from?b.to:a}),a.matches=a.matches.map(function(a){return a.a.name===b.from?a.a.name=b.to:a.b.name===b.from&&(a.b.name=b.to),a}),a}),t=p.sampledBy(r,function(a,b){return a.matches=a.matches.map(function(a){return a.id===b.match&&(a.round=b.round),a}),a}),z=Bacon.mergeAll([s,B,v,u,t]),z.throttle(10).onValue(function(a){return i?i(a.matches.value()):void 0}),s.merge(B).merge(u).throttle(10).onValue(function(a){return e.find(".standings").replaceWith(C.standings(w,y,x,g(a.participants,a.matches),null))}),m.replaceWith(C.standings(w)),v.merge(s).merge(B).throttle(10).onValue(function(b){var c,d,f,g;return c=e.find(".match"),f=b.matches.filter(function(a){return a.round}),g=b.matches.filter(function(a){return!a.round}),f.each(function(a){var b,d;return b=c.filter("[data-matchId='"+a.id+"']"),d=n.create(A,a).markup,b.length?b.replaceWith(d):e.find("div.round").filter("[data-roundId='"+a.round+"']").append(d)}),g.size()>0||i?(d=e.find("[data-roundId=0]"),0===d.length&&(d=a(o.create(r,0).markup).appendTo(e)),g.filter(function(b){return 0===a("[data-matchId='"+b.id+"']").length}).each(function(a){var b;return b=n.create(A,a).markup,d.append(b)})):void 0}),f.each(function(a){return w.push(a)}),h.each(function(a){return A.push(a)})},h={init:function(b){var c,d,f;return b=b||{},c=this,d=_(b.init),f=d.pluck("a").union(d.pluck("b").value()).pluck("name").unique(),new e(a('<div class="jqgroup"></div>').appendTo(c),f,d,b.save||null)}},a.fn.group=function(b){return h[b]?h[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?a.error("Method "+b+" does not exist on jQuery.group"):h.init.apply(this,arguments)}}(jQuery)}).call(this);