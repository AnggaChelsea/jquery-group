(function(){!function(a){var b,c,d,e,f,g,h,i;return h=function(a){return a-1+a%2},i=function(a){var b;return g.test(a)?(b=parseInt(a),isNaN(b)?null:b):null},c=function(b){return a(b.currentTarget)},b=function(a){return[a,c(a)]},e=function(a,b){return a.map(function(a){var c,d,e,f;return d=b.filter(function(a){return null!==a.a.score&&null!==a.b.score}).filter(function(b){return b.a.name===a||b.b.name===a}).map(function(b){return b.a.name===a?{ownScore:b.a.score,opponentScore:b.b.score}:{ownScore:b.b.score,opponentScore:b.a.score}}),f=d.filter(function(a){return a.ownScore>a.opponentScore}).size(),c=d.filter(function(a){return a.ownScore<a.opponentScore}).size(),e=d.filter(function(a){return a.ownScore===a.opponentScore}).size(),{name:a,wins:f,losses:c,ties:e,points:3*f+e}}).sortBy(function(a){return-a.points})},g=new RegExp(/^[0-9]+$/),d=function(d,f,g,j){var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;return j&&d.addClass("read-write"),z=function(){var b,d,e,f;return b=Handlebars.compile('        <div class="standings">        <table>        <colgroup>        <col style="width: 60%">        <col span="4" style="width: 10%">        </colgroup>        <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</tr>        {{#each this}}        <tr><td>{{name}}</td><td>{{wins}}</td><td>{{losses}}</td><td>{{ties}}</td><td>{{points}}</td></tr>        {{/each}}        </table>        </div>'),e=Handlebars.compile('        <div class="standings">        <table>        <colgroup>        <col style="width: 60%">        <col span="4" style="width: 10%">        </colgroup>        <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</tr>        {{#each this}}        <tr><td><input class="name" type="text" data-prev="{{name}}" value="{{name}}" /></td><td>{{wins}}</td><td>{{losses}}</td><td>{{ties}}</td><td>{{points}}</td></tr>        {{/each}}        <tr><td><input class="add" type="text" value="{{name}}" /></td><td colspan="4"><input type="submit" value="Add" disabled="disabled" /></td></tr>        </table>        </div>'),d=Handlebars.compile('<div class="rounds"></div>'),f=Handlebars.compile('<div class="unassigned"><header>Unassigned</header></div>'),{standings:function(d,f,g){var h,i,k,l;return g=g||_([]),j?(l=a(e(g.value())),h=l.find("input[type=submit]"),k=l.find("input").asEventStream("keyup").map(c).map(function(a){var b,c,d;return d=a.val(),b=a.attr("data-prev"),c=d.length>0&&(!g.pluck("name").contains(d)||b===d),console.log(c),{el:a,value:d,valid:c}}).toProperty(),k.onValue(function(a){return a.el.toggleClass("conflict",!a.valid),a.el.hasClass("add")?a.valid?h.removeAttr("disabled"):h.attr("disabled","disabled"):void 0}),i=k.map(function(a){return a.valid}).toProperty(),l.find("input.name").asEventStream("change").filter(i).map(".target").map(a).onValue(function(a){return f.push({from:a.attr("data-prev"),to:a.val()}),a.attr("data-prev",a.val())}),l.find("input.add").asEventStream("change").filter(i).map(".target").map(a).map(function(a){return a.val()}).onValue(function(a){return d.push(a)}),l):a(b(g.value()))},rounds:a(d()),unassigned:a(f())}}(),n=function(){var e;return e=Handlebars.compile('<div data-roundId="{{round}}" class="round" style="width: {{width}}%"><header>Round {{round}}</header></div>'),{create:function(f,g){return new function(){var h,i;i=a(e({round:g,width:100})),this.markup=i,j&&(h=0,i.asEventStream("dragover").doAction(".preventDefault").onValue(function(){}),i.asEventStream("dragenter").doAction(".preventDefault").map(c).onValue(function(a){0===h&&a.addClass("over"),h++}),i.asEventStream("dragleave").doAction(".preventDefault").map(c).onValue(function(a){h--,0===h&&a.removeClass("over")}),i.asEventStream("drop").doAction(".preventDefault").map(b).onValues(function(a,b){var c,e;h=0,c=a.originalEvent.dataTransfer.getData("Text"),e=d.find('[data-matchId="'+c+'"]'),b.append(e),b.removeClass("over"),f.push({match:parseInt(c),round:parseInt(b.attr("data-roundId"))})}))}}}}(),m=function(){var e,f,g;return e=0,f=Handlebars.compile('        <div data-matchId="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <div class="home">{{a.score}}</div>        <div class="away">{{b.score}}</div>        <span class="away">{{b.name}}</span>        </div>'),g=Handlebars.compile('        <div data-matchId="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <input type="text" class="home" value="{{a.score}}" />        <input type="text" class="away" value="{{b.score}}" />        <span class="away">{{b.name}}</span>        </div>'),{create:function(e,h){return new function(){var k;return h=a.extend({},h),h.draggable=(null!=j).toString(),j?(k=a(g(h)),this.markup=k,k.find("input").asEventStream("keyup").map(c).onValue(function(a){return a.toggleClass("conflict",null===i(a.val()))}),k.find("input").asEventStream("change").onValue(function(){var a,b,c;return a=i(k.find("input.home").val()),b=i(k.find("input.away").val()),null!==a&&null!==b?(c={a:{name:h.a.name,score:a},b:{name:h.b.name,score:b}},e.push(c)):void 0}),k.asEventStream("dragstart").map(".originalEvent").map(b).onValues(function(a,b){return a.dataTransfer.setData("Text",h.id),b.css("opacity",.5),d.find(".round").addClass("droppable")}),k.asEventStream("dragend").map(".originalEvent").map(b).onValues(function(a,b){return b.css("opacity",1),d.find(".round").removeClass("droppable")}),void 0):(this.markup=a(f(h)),void 0)}}}}(),l=a('<div class="standings"></div>').appendTo(d),k=z.rounds.appendTo(d),p=new Bacon.Bus,u=new Bacon.Bus,v=new Bacon.Bus,x=new Bacon.Bus,q=new Bacon.Bus,o=p.toProperty({participants:_([]),matches:_([])}),r=o.sampledBy(u,function(a,b){var c,e;return a.participants.size()>0&&(c=a.participants.map(function(c,d){return{id:a.matches.size()+d,a:{name:c,score:null},b:{name:b,score:null}}}),a.matches=a.matches.union(c.value())),a.participants.push(b),e=h(a.participants.size()),_(_.range(d.find(".round").length,e)).each(function(a){return k.append(n.create(q,a+1).markup)}),a}),y=o.sampledBy(x,function(a,b){return a.matches=a.matches.map(function(a){return a.a.name===b.a.name&&a.b.name===b.b.name?(a.round=b.round,a.a.score=b.a.score,a.b.score=b.b.score):a.a.name===b.b.name&&a.b.name===b.a.name&&(a.round=b.round,a.a.score=b.b.score,a.b.score=b.a.score),a}),a}),t=o.sampledBy(v,function(a,b){return a.participants=a.participants.map(function(a){return a===b.from?b.to:a}),a.matches=a.matches.map(function(a){return a.a.name===b.from?a.a.name=b.to:a.b.name===b.from&&(a.b.name=b.to),a}),a}),s=o.sampledBy(q,function(a,b){return a.matches=a.matches.map(function(a){return a.id===b.match&&(a.round=b.round),a}),a}),w=Bacon.mergeAll([r,y,t,s]),w.throttle(10).onValue(function(a){return console.log("New state created"),console.log(a),j?j(a.matches.value()):void 0}),r.merge(y).throttle(10).onValue(function(a){return d.find(".standings").replaceWith(z.standings(u,v,e(a.participants,a.matches)))}),l.replaceWith(z.standings(u)),t.merge(r).merge(y).throttle(10).onValue(function(a){var b,c;return b=d.find(".match"),c=null,a.matches.each(function(a){var e;return e=b.filter('[data-matchId="'+a.id+'"]'),e.length?e.replaceWith(m.create(x,a).markup):a.round?d.find("div.round").filter('[data-roundId="'+a.round+'"]').append(m.create(x,a).markup):(null===c&&(c=z.unassigned.appendTo(d)),c.append(m.create(x,a).markup))})}),f.each(function(a){return u.push(a)}),g.each(function(a){return x.push(a)})},f={init:function(b){var c,e,f;return b=b||{},c=this,e=_(b.init),f=e.pluck("a").union(e.pluck("b").value()).pluck("name").unique(),new d(a('<div class="jqgroup"></div>').appendTo(c),f,e,b.save||null)}},a.fn.group=function(b){return f[b]?f[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?a.error("Method "+b+" does not exist on jQuery.group"):f.init.apply(this,arguments)}}(jQuery)}).call(this);