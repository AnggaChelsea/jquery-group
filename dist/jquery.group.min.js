(function(){(function(n){var a,t,e,r,o,s,i,u;return i=function(n){return n-1+n%2},u=function(n){var a;return s.test(n)?(a=parseInt(n),isNaN(a)?null:a):null},t=function(a){return n(a.target)},a=function(n){return[n,t(n)]},r=function(n,a){return n.map(function(n){var t,e,r,o;return e=a.filter(function(n){return null!==n.a.score&&null!==n.b.score}).filter(function(a){return a.a.name===n||a.b.name===n}).map(function(a){return a.a.name===n?{ownScore:a.a.score,opponentScore:a.b.score}:{ownScore:a.b.score,opponentScore:a.a.score}}),o=e.filter(function(n){return n.ownScore>n.opponentScore}).size(),t=e.filter(function(n){return n.ownScore<n.opponentScore}).size(),r=e.filter(function(n){return n.ownScore===n.opponentScore}).size(),{name:n,wins:o,losses:t,ties:r,points:3*o+r}}).sortBy(function(n){return-n.points})},s=RegExp(/^[0-9]+$/),e=function(e,o,s,d){var c,l,p,m,v,h,f,g,b,y,w,S,B,E,V,k,I;return d&&e.addClass("read-write"),k=function(){var a,e,r,o;return a=Handlebars.compile('        <div class="standings">        Standings        <table>        <colgroup>        <col style="width: 60%">        <col span="4" style="width: 10%">        </colgroup>        <tr><th>Name</th><th>W</th><th>L</th><th>T</th><th>P</tr>        {{#each this}}        <tr><td>{{name}}</td><td>{{wins}}</td><td>{{losses}}</td><td>{{ties}}</td><td>{{points}}</td></tr>        {{/each}}        </table>        </div>'),r=Handlebars.compile('        <div class="standings">        Standings        <table>        <colgroup>        <col style="width: 60%">        <col span="4" style="width: 10%">        </colgroup>        <tr><th>Name</th><th>W</th><th>L</th><th>T</th><th>P</tr>        {{#each this}}        <tr><td><input class="name" type="text" data-prev="{{name}}" value="{{name}}" /></td><td>{{wins}}</td><td>{{losses}}</td><td>{{ties}}</td><td>{{points}}</td></tr>        {{/each}}        <tr><td><input class="add" type="text" value="{{name}}" /></td><td colspan="4"><input type="submit" value="Add" disabled="disabled" /></td></tr>        </table>        </div>'),e=Handlebars.compile('<div class="rounds"></div>'),o=Handlebars.compile('<div class="unassigned"><header>Unassigned</header></div>'),{standings:function(e,o,s){var i,u,c,l;return s=s||_([]),d?(l=n(r(s.value())),i=l.find("input[type=submit]"),c=l.find("input").asEventStream("keyup").map(t).map(function(n){var a,t,e;return e=n.val(),a=n.attr("data-prev"),t=e.length>0&&(!s.pluck("name").contains(e)||a===e),console.log(t),{el:n,value:e,valid:t}}).toProperty(),c.onValue(function(n){return n.el.toggleClass("conflict",!n.valid),n.el.hasClass("add")?n.valid?i.removeAttr("disabled"):i.attr("disabled","disabled"):void 0}),u=c.map(function(n){return n.valid}).toProperty(),l.find("input.name").asEventStream("change").filter(u).map(".target").map(n).onValue(function(n){return o.push({from:n.attr("data-prev"),to:n.val()}),n.attr("data-prev",n.val())}),l.find("input.add").asEventStream("change").filter(u).map(".target").map(n).map(function(n){return n.val()}).onValue(function(n){return e.push(n)}),l):n(a(s.value()))},rounds:n(e()),unassigned:n(o())}}(),m=function(){var r;return r=Handlebars.compile('<div data-roundId="{{round}}" class="round" style="width: {{width}}%"><header>Round {{round}}</header></div>'),{create:function(o,s){return new function(){var i;i=n(r({round:s,width:100})),this.markup=i,d&&(i.asEventStream("dragover").doAction(".preventDefault").onValue(function(){}),i.asEventStream("dragenter").doAction(".preventDefault").map(t).onValue(function(n){n.addClass("over")}),i.asEventStream("dragleave").doAction(".preventDefault").map(t).onValue(function(n){n.removeClass("over")}),i.asEventStream("drop").doAction(".preventDefault").map(a).onValues(function(n,a){var t,r;t=n.originalEvent.dataTransfer.getData("Text"),r=e.find('[data-matchId="'+t+'"]'),a.append(r),a.removeClass("over"),o.push({match:parseInt(t),round:parseInt(a.attr("data-roundId"))})}))}}}}(),p=function(){var r,o,s;return r=0,o=Handlebars.compile('        <div data-matchId="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <div class="home">{{a.score}}</div>        <span class="away">{{b.name}}</span>        <div class="away">{{b.score}}</div>        </div>'),s=Handlebars.compile('        <div data-matchId="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <input type="text" class="home" value="{{a.score}}" />        <span class="away">{{b.name}}</span>        <input type="text" class="away" value="{{b.score}}" />        </div>'),{create:function(r,i){return new function(){var c,l,p;return p=this,i=n.extend({},i),i.draggable=""+(null!=d),d?(l=n(s(i)),this.markup=l,c=l.find("input").asEventStream("keyup").map(t).onValue(function(n){return n.toggleClass("conflict",null===u(n.val()))}),l.find("input").asEventStream("change").onValue(function(){var n,a,t;return n=u(l.find("input.home").val()),a=u(l.find("input.away").val()),null!==n&&null!==a?(t={a:{name:i.a.name,score:n},b:{name:i.b.name,score:a}},r.push(t)):void 0}),l.asEventStream("dragstart").map(".originalEvent").map(a).onValues(function(n,a){return n.dataTransfer.setData("Text",i.id),a.css("opacity",.5),e.find(".round").addClass("droppable")}),l.asEventStream("dragend").map(".originalEvent").map(a).onValues(function(n,a){return a.css("opacity",1),e.find(".round").removeClass("droppable")}),void 0):(this.markup=n(o(i)),void 0)}}}}(),l=n('<div class="standings"></div>').appendTo(e),c=k.rounds.appendTo(e),h=new Bacon.Bus,w=new Bacon.Bus,S=new Bacon.Bus,E=new Bacon.Bus,f=new Bacon.Bus,v=h.toProperty({participants:_([]),matches:_([])}),g=v.sampledBy(w,function(n,a){var t,r;return n.participants.size()>0&&(t=n.participants.map(function(t,e){return{id:n.matches.size()+e,a:{name:t,score:null},b:{name:a,score:null}}}),n.matches=n.matches.union(t.value())),n.participants.push(a),r=i(n.participants.size()),_(_.range(e.find(".round").length,r)).each(function(n){return c.append(m.create(f,n+1,r).markup)}),n}),V=v.sampledBy(E,function(n,a){return n.matches=n.matches.map(function(n){return n.a.name===a.a.name&&n.b.name===a.b.name?(n.round=a.round,n.a.score=a.a.score,n.b.score=a.b.score):n.a.name===a.b.name&&n.b.name===a.a.name&&(n.round=a.round,n.a.score=a.b.score,n.b.score=a.a.score),n}),n}),y=v.sampledBy(S,function(n,a){return n.participants=n.participants.map(function(n){return n===a.from?a.to:n}),n.matches=n.matches.map(function(n){return n.a.name===a.from?n.a.name=a.to:n.b.name===a.from&&(n.b.name=a.to),n}),n}),b=v.sampledBy(f,function(n,a){return n.matches=n.matches.map(function(n){return n.id===a.match&&(n.round=a.round),n}),n}),B=Bacon.mergeAll([g,V,y,b]),B.throttle(10).onValue(function(n){return console.log("New state created"),console.log(n),d?d(n.matches.value()):void 0}),g.merge(V).throttle(10).onValue(function(n){return e.find(".standings").replaceWith(k.standings(w,S,r(n.participants,n.matches)))}),l.replaceWith(k.standings(w)),I=k.unassigned.appendTo(e),y.merge(g).merge(V).throttle(10).onValue(function(n){var a;return a=e.find(".match"),n.matches.each(function(n){var t;return t=a.filter('[data-matchId="'+n.id+'"]'),t.length?t.replaceWith(p.create(E,n).markup):n.round?e.find("div.round").filter('[data-roundId="'+n.round+'"]').append(p.create(E,n).markup):I.append(p.create(E,n).markup)})}),o.each(function(n){return w.push(n)}),s.each(function(n){return E.push(n)})},o={init:function(a){var t,r,o;return a=a||{},t=this,r=_(a.init),o=r.pluck("a").union(r.pluck("b").value()).pluck("name").unique(),new e(n('<div class="jqgroup"></div>').appendTo(t),o,r,a.save||null)}},n.fn.group=function(a){return o[a]?o[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?n.error("Method "+a+" does not exist on jQuery.group"):o.init.apply(this,arguments)}})(jQuery)}).call(this);