(function(){!function(a){var b,c,d,e,f,g,h,i,j,k,l;return j=function(a){return a-1+a%2},k=function(a){var b;return i.test(a)?(b=parseInt(a),isNaN(b)?null:b):null},c=function(b){return a(b.currentTarget)},b=function(a){return[a,c(a)]},l=function(a){return{teams:a.participants.value(),matches:a.matches.value()}},g=function(a,b){return a.map(function(a){var c,d,e,f,g,h;return d=b.filter(function(a){return null!==a.a.score&&null!==a.b.score}).filter(function(b){return b.a.name===a||b.b.name===a}).map(function(b){return b.a.name===a?{ownScore:b.a.score,opponentScore:b.b.score}:{ownScore:b.b.score,opponentScore:b.a.score}}),f=d.reduce(function(a,b){return a+b.ownScore},0),e=d.reduce(function(a,b){return a+b.opponentScore},0),h=d.filter(function(a){return a.ownScore>a.opponentScore}).size(),c=d.filter(function(a){return a.ownScore<a.opponentScore}).size(),g=d.filter(function(a){return a.ownScore===a.opponentScore}).size(),{name:a,wins:h,losses:c,ties:g,points:3*h+g,roundWins:f,roundLosses:e,ratio:f-e}}).sortBy(function(a){return-a.ratio}).sortBy(function(a){return-a.points})},i=new RegExp(/^[0-9]+$/),f=0,d=function(){return++f},e=function(e,f,h,i){var m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;return E=function(a){return e.find("[data-roundid='"+a+"']")},q=function(a){return e.find("[data-matchid='"+a+"']")},i&&e.addClass("read-write"),F=function(){var b,d,e,f;return f='        <td>{{wins}}</td>        <td>{{losses}}</td>        <td>{{ties}}</td>        <td>{{points}}</td>        <td title="Won {{roundWins}}, lost {{roundLosses}} bouts">{{ratio}}</td>',b=Handlebars.compile('        <div class="standings">        <table>        <colgroup>        <col style="width: 50%">        <col span="5" style="width: 10%">        </colgroup>        <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>R</th></tr>        {{#each this}}          <tr><td>{{name}}</td>'+f+"</tr>        {{/each}}        </table>        </div>"),e=Handlebars.compile('        <div class="standings">        <table>        <colgroup>        <col style="width: 40%">        <col span="6" style="width: 10%">        </colgroup>        <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>R</th><th>Drop?</th></tr>        {{#each this}}        <tr><td><input class="name" type="text" data-prev="{{name}}" value="{{name}}" /></td>'+f+'<td class="drop" data-name="{{name}}">Drop</td></tr>        {{/each}}        <tr><td><input class="add" type="text" value="{{name}}" /></td><td colspan="6"><input type="submit" value="Add" disabled="disabled" /></td></tr>        </table>        </div>'),d=Handlebars.compile('<div class="rounds"></div>'),{standings:function(d,f,g,h){var j,k,l,m;return h=h||_([]),i?(m=a(e(h.value())),j=m.find("input[type=submit]"),l=m.find("input").asEventStream("keyup").map(c).map(function(a){var b,c,d;return d=a.val(),b=a.attr("data-prev"),c=d.length>0&&(!h.pluck("name").contains(d)||b===d),{el:a,value:d,valid:c}}).toProperty(),l.onValue(function(a){return a.el.toggleClass("conflict",!a.valid),a.el.hasClass("add")?a.valid?j.removeAttr("disabled"):j.attr("disabled","disabled"):void 0}),k=l.map(function(a){return a.valid}).toProperty(),m.find("input.name").asEventStream("change").filter(k).map(".target").map(a).onValue(function(a){return f.push({from:a.attr("data-prev"),to:a.val()}),a.attr("data-prev",a.val())}),m.find("input.add").asEventStream("change").filter(k).map(".target").map(a).map(function(a){return a.val()}).onValue(function(a){return d.push(a)}),m.find("td.drop").asEventStream("click").map(".target").map(a).map(function(a){return a.attr("data-name")}).onValue(function(a){return g.push(a)}),m):a(b(h.value()))},rounds:a(d())}}(),p=function(){var d;return d=Handlebars.compile('        <div data-roundid="{{round}}" class="round" style="width: {{width}}%">        {{#if round}}          <header>Round {{round}}</header>        {{else}}          <header>Unassigned</header>        {{/if}}        </div>'),{create:function(e,f){return new function(){var g,h;h=a(d({round:f,width:100})),this.markup=h,i&&(g=0,h.asEventStream("dragover").doAction(".preventDefault").onValue(function(){}),h.asEventStream("dragenter").doAction(".preventDefault").map(c).onValue(function(a){0===g&&a.addClass("over"),g++}),h.asEventStream("dragleave").doAction(".preventDefault").map(c).onValue(function(a){g--,0===g&&a.removeClass("over")}),h.asEventStream("drop").doAction(".preventDefault").map(b).onValues(function(a,b){var c,d;g=0,c=a.originalEvent.dataTransfer.getData("Text"),d=q(c),b.append(d),b.removeClass("over"),e.push({match:parseInt(c),round:parseInt(b.attr("data-roundId"))})}))}}}}(),o=function(){var d,f;return d=Handlebars.compile('        <div data-matchid="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <div class="home">{{a.score}}</div>        <div class="away">{{b.score}}</div>        <span class="away">{{b.name}}</span>        </div>'),f=Handlebars.compile('        <div data-matchid="{{id}}" class="match" draggable="{{draggable}}">        <span class="home">{{a.name}}</span>        <input type="text" class="home" value="{{a.score}}" />        <input type="text" class="away" value="{{b.score}}" />        <span class="away">{{b.name}}</span>        </div>'),{create:function(g,h){return new function(){var j;return h=a.extend({},h),h.draggable=(null!=i).toString(),i?(j=a(f(h)),this.markup=j,j.find("input").asEventStream("keyup").map(c).onValue(function(a){return a.toggleClass("conflict",null===k(a.val()))}),j.find("input").asEventStream("change").onValue(function(){var a,b,c;return a=k(j.find("input.home").val()),b=k(j.find("input.away").val()),null!==a&&null!==b?(c={a:{name:h.a.name,score:a},b:{name:h.b.name,score:b}},g.push(c)):void 0}),j.asEventStream("dragstart").map(".originalEvent").map(b).onValues(function(a,b){return a.dataTransfer.setData("Text",h.id),b.css("opacity",.5),e.find(".round").addClass("droppable")}),j.asEventStream("dragend").map(".originalEvent").map(b).onValues(function(a,b){return b.css("opacity",1),e.find(".droppable").removeClass("droppable")}),void 0):(this.markup=a(d(h)),void 0)}}}}(),n=a('<div class="standings"></div>').appendTo(e),m=F.rounds.appendTo(e),s=new Bacon.Bus,y=new Bacon.Bus,A=new Bacon.Bus,C=new Bacon.Bus,t=new Bacon.Bus,z=new Bacon.Bus,r=s.toProperty({participants:_([]),matches:_([])}),u=r.sampledBy(y,function(a,b){var c,e;return a.participants.size()>0&&(c=a.participants.map(function(a){return{id:d(),a:{name:a,score:null},b:{name:b,score:null}}}),a.matches=a.matches.union(c.value())),a.participants.push(b),e=j(a.participants.size()),_(_.range(m.find(".round").length,e)).each(function(a){return m.append(p.create(t,a+1).markup)}),a}),w=r.sampledBy(z,function(a,b){var c,d,e;return a.matches.filter(function(a){return a.a.name===b||a.b.name===b}).map(function(a){return a.id}).forEach(function(a){return q(a).remove()}),e=j(a.participants.size()),a.participants=a.participants.filter(function(a){return a!==b}),d=j(a.participants.size()),a.matches=a.matches.filter(function(a){return a.a.name!==b&&a.b.name!==b}).map(function(a){return a.round>d&&(a.round=0),a}),c=E(0),_(_.range(d+1,e+1)).each(function(a){var b,d;return d=E(a),b=d.find(".match"),c.append(b),d.remove()}),a}),D=r.sampledBy(C,function(a,b){return a.matches=a.matches.map(function(a){return a.a.name===b.a.name&&a.b.name===b.b.name?(void 0!==b.round&&(a.round=b.round),a.a.score=b.a.score,a.b.score=b.b.score):a.a.name===b.b.name&&a.b.name===b.a.name&&(void 0!==b.round&&(a.round=b.round),a.a.score=b.b.score,a.b.score=b.a.score),a}),a}),x=r.sampledBy(A,function(a,b){return a.participants=a.participants.map(function(a){return a===b.from?b.to:a}),a.matches=a.matches.map(function(a){return a.a.name===b.from?a.a.name=b.to:a.b.name===b.from&&(a.b.name=b.to),a}),a}),v=r.sampledBy(t,function(a,b){return a.matches=a.matches.map(function(a){return a.id===b.match&&(a.round=b.round),a}),a}),B=Bacon.mergeAll([u,D,x,w,v]),B.throttle(10).onValue(function(a){return i?i(l(a)):void 0}),u.merge(D).merge(w).throttle(10).onValue(function(a){return e.find(".standings").replaceWith(F.standings(y,A,z,g(a.participants,a.matches),null))}),n.replaceWith(F.standings(y)),x.merge(u).merge(D).throttle(10).onValue(function(b){var c,d,f;return d=b.matches.filter(function(a){return a.round}),f=b.matches.filter(function(a){return!a.round}),d.each(function(a){var b,c;return b=q(a.id),c=o.create(C,a).markup,b.length?b.replaceWith(c):E(a.round).append(c)}),f.size()>0||i?(c=E(0),0===c.length&&(c=a(p.create(t,0).markup).appendTo(e)),f.filter(function(a){return 0===q(a.id).length}).each(function(a){var b;return b=o.create(C,a).markup,c.append(b)})):void 0}),f.each(function(a){return y.push(a)}),h.each(function(a){return C.push(a)})},h={init:function(b){var c,d,f,g;return b=b||{},c=this,d=_(null!=(g=b.init)?g.matches:void 0),f=d.pluck("a").union(d.pluck("b").value()).pluck("name").unique(),new e(a('<div class="jqgroup"></div>').appendTo(c),f,d,b.save||null)}},a.fn.group=function(b){return h[b]?h[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?a.error("Method "+b+" does not exist on jQuery.group"):h.init.apply(this,arguments)}}(jQuery)}).call(this);