(function(){!function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;return s={win:3,tie:1,loss:0},o=function(a){return a-1+a%2},y=function(a){var b;return n.test(a)?(b=parseInt(a),isNaN(b)?null:b):null},d=function(b){return a(b.currentTarget)},c=function(a){return[a,d(a)]},x=function(a,b){return a.findIndex(function(a){return a.id===b.id})},z=function(a){return{teams:a.participants.value(),matches:a.matches.map(function(b){return{a:{team:x(a.participants,b.a.team),score:b.a.score},b:{team:x(a.participants,b.b.team),score:b.b.score},round:b.round}}).value()}},j=function(a,b){return a.map(function(a){var c,d,e,f,g,h;return d=b.filter(function(a){return null!==a.a.score&&null!==a.b.score}).filter(function(b){return b.a.team===a||b.b.team===a}).map(function(b){return b.a.team===a?{ownScore:b.a.score,opponentScore:b.b.score}:{ownScore:b.b.score,opponentScore:b.a.score}}),f=d.reduce(function(a,b){return a+b.ownScore},0),e=d.reduce(function(a,b){return a+b.opponentScore},0),h=d.filter(function(a){return a.ownScore>a.opponentScore}).size(),c=d.filter(function(a){return a.ownScore<a.opponentScore}).size(),g=d.filter(function(a){return a.ownScore===a.opponentScore}).size(),{team:a,wins:h,losses:c,ties:g,points:h*s.win+g*s.tie+c*s.loss,roundWins:f,roundLosses:e,ratio:f-e}}).sortBy(function(a){return-a.ratio}).sortBy(function(a){return-a.points})},n=new RegExp(/^[0-9]+$/),u='    <td>{{wins}}</td>    <td>{{losses}}</td>    <td>{{ties}}</td>    <td>{{points}}</td>    <td title="Won {{roundWins}}, lost {{roundLosses}} bouts">{{ratio}}</td>',v=Handlebars.compile('    <div class="standings">    <table>    <colgroup>    <col style="width: 50%">    <col span="5" style="width: 10%">    </colgroup>    <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>&plusmn;</th></tr>    {{#each this}}    <tr data-teamid="{{team.id}}"><td>{{#if team.label}}{{team.label}}{{else}}{{team.name}}{{/if}}</td>'+u+"</tr>    {{/each}}    </table>    </div>"),t=Handlebars.compile('    <div class="standings">    <table>    <colgroup>    <col style="width: 40%">    <col span="6" style="width: 10%">    </colgroup>    <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>R</th><th></th></tr>    {{#each this}}    <tr><td><input class="name" type="text" data-prev="{{team.name}}" data-teamid="{{team.id}}" value="{{team.name}}" /></td>'+u+'<td class="drop" data-name="{{team.id}}" title="Drop team">&#x232B;</td></tr>    {{/each}}    <tr><td><input class="add" type="text" /></td><td colspan="6"><input type="submit" value="Add" disabled="disabled" /></td></tr>    </table>    </div>'),p=Handlebars.compile('    <div data-roundid="{{this}}" class="round">    {{#if this}}    <header>Round {{this}}</header>    {{else}}    <header>Unassigned</header>    {{/if}}    </div>'),l=Handlebars.compile('    <div data-matchid="{{id}}" class="match" draggable="{{draggable}}">      <div class="team" data-teamid="{{a.team.id}}">        <div class="label">{{a.team.label}}</div>        <div class="score {{homeClass}}">{{a.score}}</div>      </div>      <div class="team" data-teamid="{{b.team.id}}">        <div class="score {{awayClass}}">{{b.score}}</div>        <div class="label">{{b.team.label}}</div>      </div>    </div>'),k=Handlebars.compile('    <div data-matchid="{{id}}" class="match" draggable="{{draggable}}">      <div class="team" data-teamid="{{b.team.id}}">        <div class="label">{{a.team.name}}</div>        <input type="text" class="score home" value="{{a.score}}" />      </div>      <div class="team" data-teamid="{{b.team.id}}">        <input type="text" class="score away" value="{{b.score}}" />        <div class="label">{{b.team.name}}</div>      </div>    </div>'),q=Handlebars.compile('    <header class="roundsHeader">Rounds</header>'),r=Handlebars.compile('<div class="rounds"></div>'),b=function(a){return a.name},h=0,e=function(){return++h},i=0,f=function(){return++i},w=function(b,c){return function(){var d;return d=a(this).attr("data-teamid"),b.find("[data-teamid="+d+"]").toggleClass("highlight",c)}},g=function(b,g,h,i){var m,n,s,u,x,A,B,C,D,E,F,G,H,I,J,K,L,M,N;return M=function(a){return b.find("[data-roundid='"+a+"']")},u=function(a){return b.find("[data-matchid='"+a+"']")},i&&b.addClass("read-write"),N=function(){return{standings:function(c,e,g,h){var j,k,l,m,n,o;return h=h||_([]),i?(n=a(t(h.value())),k=n.find("input[type=submit]"),m=n.find("input").asEventStream("keyup").map(d).map(function(a){var b,c,d;return d=a.val(),b=a.attr("data-prev"),c=d.length>0&&(!h.map(function(a){return a.team}).pluck("name").contains(d)||b===d),{el:a,value:d,valid:c}}).toProperty(),m.onValue(function(a){return a.el.toggleClass("conflict",!a.valid),a.el.hasClass("add")?a.valid?k.removeAttr("disabled"):k.attr("disabled","disabled"):void 0}),l=m.map(function(a){return a.valid}).toProperty(),n.find("input.name").asEventStream("change").filter(l).map(".target").map(a).onValue(function(a){return e.push({id:parseInt(a.attr("data-teamid")),to:a.val()}),a.attr("data-prev",a.val())}),n.find("input.add").asEventStream("change").filter(l).map(".target").map(a).map(function(a){return a.val()}).onValue(function(a){return c.push({id:f(),name:a})}),n.find("td.drop").asEventStream("click").map(".target").map(a).map(function(a){return a.attr("data-name")}).onValue(function(a){return g.push(parseInt(a))}),n):(j=a(v(h.value())),o=w.bind(null,b),j.find("[data-teamid]").hover(o(!0),o(!1)),j)},roundsHeader:function(b){var c;return c=a(q()),c.asEventStream("click").onValue(function(){return b.toggle()}),c},rounds:a(r()),round:function(b){return a(p(b))},matchEdit:function(b){return a(k(b))},matchView:function(b){var c,d;return d=b.a.score>b.b.score,c={homeClass:d?"win":"lose",awayClass:d?"lose":"win"},a(l(_.extend(c,b)))}}}(),s=function(){return{create:function(a,b){return new function(){var e,f;f=N.round(b),this.markup=f,i&&(e=0,f.asEventStream("dragover").doAction(".preventDefault").onValue(function(){}),f.asEventStream("dragenter").doAction(".preventDefault").map(d).onValue(function(a){0===e&&a.addClass("over"),e++}),f.asEventStream("dragleave").doAction(".preventDefault").map(d).onValue(function(a){e--,0===e&&a.removeClass("over")}),f.asEventStream("drop").doAction(".preventDefault").map(c).onValues(function(b,c){var d,f;e=0,d=b.originalEvent.dataTransfer.getData("Text"),f=u(d),c.append(f),c.removeClass("over"),a.push({match:parseInt(d),round:parseInt(c.attr("data-roundId"))})}))}}}}(),n=function(){return{create:function(e,f){return new function(){var g;return f=a.extend({},f),f.draggable=(null!=i).toString(),i?(g=N.matchEdit(f),this.markup=g,g.find("input").asEventStream("keyup").map(d).onValue(function(a){return a.toggleClass("conflict",null===y(a.val()))}),g.find("input").asEventStream("change").onValue(function(){var a,b,c;return a=y(g.find("input.home").val()),b=y(g.find("input.away").val()),null!==a&&null!==b?(c={a:{team:f.a.team,score:a},b:{team:f.b.team,score:b}},e.push(c)):void 0}),g.asEventStream("dragstart").map(".originalEvent").map(c).onValues(function(a,c){return a.dataTransfer.setData("Text",f.id),c.css("opacity",.5),b.find(".round").addClass("droppable")}),g.asEventStream("dragend").map(".originalEvent").map(c).onValues(function(a,c){return c.css("opacity",1),b.find(".droppable").removeClass("droppable")}),void 0):(this.markup=N.matchView(f),void 0)}}}}(),A=new Bacon.Bus,G=new Bacon.Bus,I=new Bacon.Bus,K=new Bacon.Bus,B=new Bacon.Bus,H=new Bacon.Bus,x=A.toProperty({participants:_([]),matches:_([])}),m=N.rounds.append(a(s.create(B,0).markup)),b.append(N.standings(G)).append(N.roundsHeader(m)).append(m),C=x.sampledBy(G,function(a,b){var c,d;return a.participants.size()>0&&(c=a.participants.map(function(a){return{id:e(),a:{team:a,score:null},b:{team:b,score:null}}}),a.matches=a.matches.union(c.value())),a.participants.push(b),d=o(a.participants.size()),_(_.range(m.find(".round").length-1,d)).each(function(a){return m.append(s.create(B,a+1).markup)}),a}),E=x.sampledBy(H,function(a,b){var c,d,e;return a.matches.filter(function(a){return a.a.team.id===b||a.b.team.id===b}).map(function(a){return a.id}).forEach(function(a){return u(a).remove()}),e=o(a.participants.size()),a.participants=a.participants.filter(function(a){return a.id!==b}),d=o(a.participants.size()),a.matches=a.matches.filter(function(a){return a.a.team.id!==b&&a.b.team.id!==b}).map(function(a){return a.round>d&&(a.round=0),a}),c=M(0),_(_.range(d+1,e+1)).each(function(a){var b,d;return d=M(a),b=d.find(".match"),c.append(b),d.remove()}),a}),L=x.sampledBy(K,function(a,b){return a.matches=a.matches.map(function(a){return a.a.team.id===b.a.team.id&&a.b.team.id===b.b.team.id?(void 0!==b.round&&(a.round=b.round),a.a.score=b.a.score,a.b.score=b.b.score):a.a.team.id===b.b.team.id&&a.b.team.id===b.a.team.id&&(void 0!==b.round&&(a.round=b.round),a.a.score=b.b.score,a.b.score=b.a.score),a}),a}),F=x.sampledBy(I,function(a,b){return a.participants=a.participants.map(function(a){return a.id===b.id&&(a.name=b.to),a}),a}),D=x.sampledBy(B,function(a,b){return a.matches=a.matches.map(function(a){return a.id===b.match&&(a.round=b.round),a}),a}),J=Bacon.mergeAll([C,L,F,E,D]),J.throttle(10).onValue(function(a){return i?i(z(a)):void 0}),C.merge(L).merge(E).throttle(10).onValue(function(a){return b.find(".standings").replaceWith(N.standings(G,I,H,j(a.participants,a.matches),null))}),F.merge(C).merge(L).throttle(10).onValue(function(a){var b,c,d;return c=a.matches.filter(function(a){return a.round}),d=a.matches.filter(function(a){return!a.round}),c.each(function(a){var b,c;return b=u(a.id),c=n.create(K,a).markup,b.length?b.replaceWith(c):M(a.round).append(c)}),d.size()>0||i?(b=M(0),b.show(),d.each(function(a){var c,d;return c=u(a.id),d=n.create(K,a).markup,c.length?c.replaceWith(d):b.append(d)})):void 0}),g.each(function(a){return G.push(a)}),h.each(function(a){return K.push(a)})},m={init:function(c){var d,e,f,h;return c=c||{},e=c.labeler||b,d=this,h=_(),f=_(),c.init&&(h=_(c.init.teams).map(function(a){return a.label=new Handlebars.SafeString(e(a)),a}),f=_(c.init.matches).map(function(a){return a.a.team=c.init.teams[a.a.team],a.b.team=c.init.teams[a.b.team],a})),g(a('<div class="jqgroup"></div>').appendTo(d),h,f,c.save||null)}},a.fn.group=function(b){return m[b]?m[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?a.error("Method "+b+" does not exist on jQuery.group"):m.init.apply(this,arguments)}}(jQuery)}).call(this);