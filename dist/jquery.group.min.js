(function(){!function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;return s={win:3,tie:1,loss:0},o=function(a){return a-1+a%2},x=function(a){var b;return n.test(a)?(b=parseInt(a),isNaN(b)?null:b):null},d=function(b){return a(b.currentTarget)},c=function(a){return[a,d(a)]},w=function(a,b){return a.findIndex(function(a){return a.id===b.id})},y=function(a){return{teams:a.participants.value(),matches:a.matches.map(function(b){return{a:{team:w(a.participants,b.a.team),score:b.a.score},b:{team:w(a.participants,b.b.team),score:b.b.score},round:b.round}}).value()}},j=function(a,b){return a.map(function(a){var c,d,e,f,g,h;return d=b.filter(function(a){return null!==a.a.score&&null!==a.b.score}).filter(function(b){return b.a.team===a||b.b.team===a}).map(function(b){return b.a.team===a?{ownScore:b.a.score,opponentScore:b.b.score}:{ownScore:b.b.score,opponentScore:b.a.score}}),f=d.reduce(function(a,b){return a+b.ownScore},0),e=d.reduce(function(a,b){return a+b.opponentScore},0),h=d.filter(function(a){return a.ownScore>a.opponentScore}).size(),c=d.filter(function(a){return a.ownScore<a.opponentScore}).size(),g=d.filter(function(a){return a.ownScore===a.opponentScore}).size(),{team:a,wins:h,losses:c,ties:g,points:h*s.win+g*s.tie+c*s.loss,roundWins:f,roundLosses:e,ratio:f-e}}).sortBy(function(a){return-a.ratio}).sortBy(function(a){return-a.points})},n=new RegExp(/^[0-9]+$/),u='    <td>{{wins}}</td>    <td>{{losses}}</td>    <td>{{ties}}</td>    <td>{{points}}</td>    <td title="Won {{roundWins}}, lost {{roundLosses}} bouts">{{ratio}}</td>',v=Handlebars.compile('    <div class="standings">    <table>    <colgroup>    <col style="width: 50%">    <col span="5" style="width: 10%">    </colgroup>    <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>R</th></tr>    {{#each this}}    <tr><td>{{#if team.label}}{{team.label}}{{else}}{{team.name}}{{/if}}</td>'+u+"</tr>    {{/each}}    </table>    </div>"),t=Handlebars.compile('    <div class="standings">    <table>    <colgroup>    <col style="width: 40%">    <col span="6" style="width: 10%">    </colgroup>    <tr><th></th><th>W</th><th>L</th><th>T</th><th>P</th><th>R</th><th>Drop?</th></tr>    {{#each this}}    <tr><td><input class="name" type="text" data-prev="{{team.name}}" data-teamid="{{team.id}}" value="{{team.name}}" /></td>'+u+'<td class="drop" data-name="{{team.id}}">Drop</td></tr>    {{/each}}    <tr><td><input class="add" type="text" /></td><td colspan="6"><input type="submit" value="Add" disabled="disabled" /></td></tr>    </table>    </div>'),p=Handlebars.compile('    <div data-roundid="{{this}}" class="round">    {{#if this}}    <header>Round {{this}}</header>    {{else}}    <header>Unassigned</header>    {{/if}}    </div>'),l=Handlebars.compile('    <div data-matchid="{{id}}" class="match" draggable="{{draggable}}">    <span class="home">{{a.team.label}}</span>    <div class="home">{{a.score}}</div>    <div class="away">{{b.score}}</div>    <span class="away">{{b.team.label}}</span>    </div>'),k=Handlebars.compile('    <div data-matchid="{{id}}" class="match" draggable="{{draggable}}">    <span class="home">{{a.team.name}}</span>    <input type="text" class="home" value="{{a.score}}" />    <input type="text" class="away" value="{{b.score}}" />    <span class="away">{{b.team.name}}</span>    </div>'),q=Handlebars.compile('    <header class="roundsHeader">Rounds</header>'),r=Handlebars.compile('<div class="rounds"></div>'),b=function(a){return a.name},h=0,e=function(){return++h},i=0,f=function(){return++i},g=function(b,g,h,i){var m,n,s,u,w,z,A,B,C,D,E,F,G,H,I,J,K,L,M;return L=function(a){return b.find("[data-roundid='"+a+"']")},u=function(a){return b.find("[data-matchid='"+a+"']")},i&&b.addClass("read-write"),M=function(){return{standings:function(b,c,e,g){var h,j,k,l;return g=g||_([]),i?(l=a(t(g.value())),h=l.find("input[type=submit]"),k=l.find("input").asEventStream("keyup").map(d).map(function(a){var b,c,d;return d=a.val(),b=a.attr("data-prev"),c=d.length>0&&(!g.map(function(a){return a.team}).pluck("name").contains(d)||b===d),{el:a,value:d,valid:c}}).toProperty(),k.onValue(function(a){return a.el.toggleClass("conflict",!a.valid),a.el.hasClass("add")?a.valid?h.removeAttr("disabled"):h.attr("disabled","disabled"):void 0}),j=k.map(function(a){return a.valid}).toProperty(),l.find("input.name").asEventStream("change").filter(j).map(".target").map(a).onValue(function(a){return c.push({id:parseInt(a.attr("data-teamid")),to:a.val()}),a.attr("data-prev",a.val())}),l.find("input.add").asEventStream("change").filter(j).map(".target").map(a).map(function(a){return a.val()}).onValue(function(a){return b.push({id:f(),name:a})}),l.find("td.drop").asEventStream("click").map(".target").map(a).map(function(a){return a.attr("data-name")}).onValue(function(a){return e.push(parseInt(a))}),l):a(v(g.value()))},roundsHeader:function(b){var c;return c=a(q()),c.asEventStream("click").onValue(function(){return b.toggle()}),c},rounds:a(r()),round:function(b){return a(p(b))},matchEdit:function(b){return a(k(b))},matchView:function(b){return a(l(b))}}}(),s=function(){return{create:function(a,b){return new function(){var e,f;f=M.round(b),this.markup=f,i&&(e=0,f.asEventStream("dragover").doAction(".preventDefault").onValue(function(){}),f.asEventStream("dragenter").doAction(".preventDefault").map(d).onValue(function(a){0===e&&a.addClass("over"),e++}),f.asEventStream("dragleave").doAction(".preventDefault").map(d).onValue(function(a){e--,0===e&&a.removeClass("over")}),f.asEventStream("drop").doAction(".preventDefault").map(c).onValues(function(b,c){var d,f;e=0,d=b.originalEvent.dataTransfer.getData("Text"),f=u(d),c.append(f),c.removeClass("over"),a.push({match:parseInt(d),round:parseInt(c.attr("data-roundId"))})}))}}}}(),n=function(){return{create:function(e,f){return new function(){var g;return f=a.extend({},f),f.draggable=(null!=i).toString(),i?(g=M.matchEdit(f),this.markup=g,g.find("input").asEventStream("keyup").map(d).onValue(function(a){return a.toggleClass("conflict",null===x(a.val()))}),g.find("input").asEventStream("change").onValue(function(){var a,b,c;return a=x(g.find("input.home").val()),b=x(g.find("input.away").val()),null!==a&&null!==b?(c={a:{team:f.a.team,score:a},b:{team:f.b.team,score:b}},e.push(c)):void 0}),g.asEventStream("dragstart").map(".originalEvent").map(c).onValues(function(a,c){return a.dataTransfer.setData("Text",f.id),c.css("opacity",.5),b.find(".round").addClass("droppable")}),g.asEventStream("dragend").map(".originalEvent").map(c).onValues(function(a,c){return c.css("opacity",1),b.find(".droppable").removeClass("droppable")}),void 0):(this.markup=M.matchView(f),void 0)}}}}(),z=new Bacon.Bus,F=new Bacon.Bus,H=new Bacon.Bus,J=new Bacon.Bus,A=new Bacon.Bus,G=new Bacon.Bus,w=z.toProperty({participants:_([]),matches:_([])}),m=M.rounds.append(a(s.create(A,0).markup)),b.append(M.standings(F)).append(M.roundsHeader(m)).append(m),B=w.sampledBy(F,function(a,b){var c,d;return a.participants.size()>0&&(c=a.participants.map(function(a){return{id:e(),a:{team:a,score:null},b:{team:b,score:null}}}),a.matches=a.matches.union(c.value())),a.participants.push(b),d=o(a.participants.size()),_(_.range(m.find(".round").length-1,d)).each(function(a){return m.append(s.create(A,a+1).markup)}),a}),D=w.sampledBy(G,function(a,b){var c,d,e;return a.matches.filter(function(a){return a.a.team.id===b||a.b.team.id===b}).map(function(a){return a.id}).forEach(function(a){return u(a).remove()}),e=o(a.participants.size()),a.participants=a.participants.filter(function(a){return a.id!==b}),d=o(a.participants.size()),a.matches=a.matches.filter(function(a){return a.a.team.id!==b&&a.b.team.id!==b}).map(function(a){return a.round>d&&(a.round=0),a}),c=L(0),_(_.range(d+1,e+1)).each(function(a){var b,d;return d=L(a),b=d.find(".match"),c.append(b),d.remove()}),a}),K=w.sampledBy(J,function(a,b){return a.matches=a.matches.map(function(a){return a.a.team.id===b.a.team.id&&a.b.team.id===b.b.team.id?(void 0!==b.round&&(a.round=b.round),a.a.score=b.a.score,a.b.score=b.b.score):a.a.team.id===b.b.team.id&&a.b.team.id===b.a.team.id&&(void 0!==b.round&&(a.round=b.round),a.a.score=b.b.score,a.b.score=b.a.score),a}),a}),E=w.sampledBy(H,function(a,b){return a.participants=a.participants.map(function(a){return a.id===b.id&&(a.name=b.to),a}),a}),C=w.sampledBy(A,function(a,b){return a.matches=a.matches.map(function(a){return a.id===b.match&&(a.round=b.round),a}),a}),I=Bacon.mergeAll([B,K,E,D,C]),I.throttle(10).onValue(function(a){return i?i(y(a)):void 0}),B.merge(K).merge(D).throttle(10).onValue(function(a){return b.find(".standings").replaceWith(M.standings(F,H,G,j(a.participants,a.matches),null))}),E.merge(B).merge(K).throttle(10).onValue(function(a){var b,c,d;return c=a.matches.filter(function(a){return a.round}),d=a.matches.filter(function(a){return!a.round}),c.each(function(a){var b,c;return b=u(a.id),c=n.create(J,a).markup,b.length?b.replaceWith(c):L(a.round).append(c)}),d.size()>0||i?(b=L(0),b.show(),d.each(function(a){var c,d;return c=u(a.id),d=n.create(J,a).markup,c.length?c.replaceWith(d):b.append(d)})):void 0}),g.each(function(a){return F.push(a)}),h.each(function(a){return J.push(a)})},m={init:function(c){var d,e,f,h;return c=c||{},e=c.labeler||b,d=this,h=_(),f=_(),c.init&&(h=_(c.init.teams).map(function(a){return a.label=new Handlebars.SafeString(e(a)),a}),f=_(c.init.matches).map(function(a){return a.a.team=c.init.teams[a.a.team],a.b.team=c.init.teams[a.b.team],a})),g(a('<div class="jqgroup"></div>').appendTo(d),h,f,c.save||null)}},a.fn.group=function(b){return m[b]?m[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?a.error("Method "+b+" does not exist on jQuery.group"):m.init.apply(this,arguments)}}(jQuery)}).call(this);